<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thesis Brainstorming Tool</title>
    <link rel="stylesheet" href="/static/styles.css?v=academic-theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&family=Source+Sans+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">

</head>

<body>
<!--    <nav class="navbar">-->
<!--        <div class="logo-container">-->
<!--            <img src="{{ url_for('static', path='/IVIS_logo.png') }}" alt="IVIS Labs">-->
<!--            <img src="{{ url_for('static', path='/NIE_University.png') }}" alt="NIE University">-->
<!--            <img src="{{ url_for('static', path='/PULSE_LOGO.png') }}" alt="PULSE">-->
<!--        </div>-->
<!--    </nav>-->

    <div class="container">
        <header class="hero-section">
            <div class="hero-content">
                <h1><i class="fas fa-brain gradient-icon"></i> Thesis Brainstorming Tool</h1>
                <p class="hero-subtitle">Generate innovative and research-ready thesis ideas powered by advanced AI</p>
            </div>
        </header>



        <div class="content-wrapper">
            <div class="form-container">
                <form id="thesisForm">
                    <div class="form-group">
                        <label for="field_of_study">Research Area</label>
                        <input type="text" id="field_of_study" name="field_of_study" required placeholder="e.g., Computer Science, Environmental Science">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="num_ideas">Number of Ideas</label>
                            <select id="num_ideas" name="num_ideas">
                                <option value="1">1</option>
                                <option value="3" selected>3</option>
                                <option value="5">5</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="thesis_type">Thesis Type</label>
                            <select id="thesis_type" name="thesis_type">
                                <option value="argumentative" selected>Argumentative</option>
                                <option value="analytical">Analytical</option>
                                <option value="expository">Expository</option>
                                <option value="comparative">Comparative</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tone">Tone</label>
                            <select id="tone" name="tone">
                                <option value="academic" selected>Academic</option>
                                <option value="persuasive">Persuasive</option>
                                <option value="neutral">Neutral</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="model">Model</label>
                            <select id="model" name="model">
                                <option value="gemma2:2b" selected>Gemma 2B</option>
                                <!-- Other models will be loaded dynamically -->
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="generateBtn"><i class="fas fa-lightbulb"></i> Generate Thesis Ideas</button>
                </form>
            </div>

            <div class="results-container" id="resultsContainer" style="display: none;">
                <h2><i class="fas fa-scroll"></i> Generated Thesis Ideas</h2>
                <div id="loading" style="display: none;">
                    <p>Crafting your thesis ideas with scholarly precision...</p>
                    <div class="loading-spinner">
                        <div class="pen-writing">
                            <div class="pen"></div>
                            <div class="ink-line"></div>
                        </div>
                    </div>
                    <div class="academic-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div id="results"></div>
                <div class="results-buttons">
                    <button id="copyBtn" style="display: none;"><i class="fas fa-copy"></i> Copy to Clipboard</button>
                    <button id="regenerateBtn" style="display: none;"><i class="fas fa-sync-alt"></i> Generate New Ideas</button>
                </div>
            </div>
        </div>
    </div>

<!--    <footer>-->
<!--        <p>Â© 2024 IVIS Labs & NIE University. All rights reserved.</p>-->
<!--    </footer>-->

    <script>
        // Load models when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            loadModels();
        });

        async function loadModels() {
            try {
                const response = await fetch('/models');

                if (response.ok) {
                    const data = await response.json();
                    if (data.data && Array.isArray(data.data)) {
                        const modelSelect = document.getElementById('model');
                        // Clear existing options
                        modelSelect.innerHTML = '';

                        data.data.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = model.id;
                            if (model.id === 'llama-3.3-70b-versatile') {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        document.getElementById('thesisForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const copyBtn = document.getElementById('copyBtn');
            const regenerateBtn = document.getElementById('regenerateBtn');
            const generateBtn = document.getElementById('generateBtn');

            // Show loading state
            resultsContainer.style.display = 'block';
            loading.style.display = 'flex';
            results.innerHTML = '';
            copyBtn.style.display = 'none';
            regenerateBtn.style.display = 'none';
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        console.error('Server error response:', errorData);
                        errorMessage = errorData.detail || `Error: ${response.status} ${response.statusText}`;
                    } catch (e) {
                        console.error('Could not parse error response');
                        errorMessage = `Error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (!data.ideas) {
                    throw new Error("Invalid API response: 'ideas' not found.");
                }
                results.innerHTML = formatThesisIdeas(data.ideas);
                copyBtn.style.display = 'inline-block';
                regenerateBtn.style.display = 'inline-block';
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <p><i class="fas fa-exclamation-triangle"></i> ${error.message}</p>
                        <p>Possible solutions:</p>
                        <ul>
                            <li>Check your internet connection</li>
                            <li>Verify that the language model services are running</li>
                            <li>Try refreshing the page and generating again</li>
                        </ul>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Generate Thesis Ideas';
            }
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            const results = document.getElementById('results').innerText;
            navigator.clipboard.writeText(results)
                .then(() => {
                    const copyBtn = document.getElementById('copyBtn');
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy to Clipboard';
                    }, 2000);
                })
                .catch(err => console.error('Failed to copy: ', err));
        });

        document.getElementById('regenerateBtn').addEventListener('click', () => {
            document.getElementById('thesisForm').dispatchEvent(new Event('submit'));
        });

        function formatThesisIdeas(text) {
            // Check if text is actually a string
            if (typeof text !== 'string') {
                return '<div class="error">Error: Invalid data format received</div>';
            }

            let formattedText = text;

            // Replace common numbered patterns with styled headers
            // Handle both "1. **Title:**" and "**Title:**" patterns
            formattedText = formattedText.replace(/(\d+)\.\s*\*\*(.*?)\*\*/g, '<div class="thesis-idea"><h3>Thesis Idea $1: $2</h3>');
            
            // Also handle simple numbered patterns
            formattedText = formattedText.replace(/(?:^|\n)(?:Thesis Idea |Thesis |Idea |)(\d+)[:\.]\s*(.*?)(?=\n|$)/gi,
                '<div class="thesis-idea"><h3>Thesis Idea $1: $2</h3>');

            // Add closing divs for thesis ideas
            const ideaCount = (formattedText.match(/<div class="thesis-idea">/g) || []).length;

            if (ideaCount > 0) {
                // Split content by thesis ideas and add proper paragraph formatting
                let parts = formattedText.split('<div class="thesis-idea">');
                formattedText = parts[0];

                for (let i = 1; i < parts.length; i++) {
                    let content = parts[i];
                    // Find the end of the thesis title (after the first newline or paragraph break)
                    let titleMatch = content.match(/^<h3>(.*?)<\/h3>(.*)$/s);
                    if (titleMatch) {
                        let title = titleMatch[1];
                        let description = titleMatch[2].trim();
                        
                        // Format description as paragraph with proper formatting
                        description = description.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold text
                        description = description.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>');
                        if (description && !description.startsWith('<p>')) {
                            description = '<p>' + description + '</p>';
                        }
                        
                        formattedText += '<div class="thesis-idea"><h3>' + title + '</h3>' + description + '</div>';
                    } else {
                        formattedText += '<div class="thesis-idea">' + content + '</div>';
                    }
                }
            } else {
                // If no thesis ideas were found, just wrap in paragraphs
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold text
                formattedText = formattedText.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>');
                if (formattedText && !formattedText.startsWith('<p>')) {
                    formattedText = '<p>' + formattedText + '</p>';
                }
            }

            return formattedText;
        }
    </script>
</body>
</html>